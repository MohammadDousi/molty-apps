generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ww_user {
  id                Int             @id @default(autoincrement())
  wakawars_username String          @unique
  api_key           String          @default("")
  password_hash     String?
  friendships       ww_friendship[] @relation("user_friendships")
  friend_of         ww_friendship[] @relation("friend_friendships")
  sessions          ww_session[]
  daily_stats       ww_daily_stat[]
  weekly_stats      ww_weekly_stat[]
  provider_logs     ww_provider_log[]
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
}

model ww_friendship {
  id         Int      @id @default(autoincrement())
  user_id    Int
  friend_id  Int
  user       ww_user  @relation("user_friendships", fields: [user_id], references: [id], onDelete: Cascade)
  friend     ww_user  @relation("friend_friendships", fields: [friend_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([user_id, friend_id])
  @@index([friend_id])
}

model ww_session {
  id           Int      @id @default(autoincrement())
  token        String   @unique
  user_id      Int
  user         ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  created_at   DateTime @default(now())
  last_used_at DateTime @default(now())
}

model ww_daily_stat {
  id            Int      @id @default(autoincrement())
  user_id       Int
  user          ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  date_key      String
  total_seconds Int      @default(0)
  status        String
  error         String?
  fetched_at    DateTime @default(now())
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([user_id, date_key])
  @@index([date_key])
}

model ww_weekly_stat {
  id                    Int      @id @default(autoincrement())
  user_id               Int
  user                  ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  range_key             String
  total_seconds         Int      @default(0)
  daily_average_seconds Int      @default(0)
  status                String
  error                 String?
  fetched_at            DateTime @default(now())
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@unique([user_id, range_key])
  @@index([range_key])
}

model ww_provider_log {
  id          Int      @id @default(autoincrement())
  provider    String
  user_id     Int?
  user        ww_user? @relation(fields: [user_id], references: [id], onDelete: SetNull)
  endpoint    String
  range_key   String?
  status_code Int?
  ok          Boolean  @default(false)
  payload     Json?
  error       String?
  fetched_at  DateTime @default(now())
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([provider])
  @@index([user_id])
  @@index([endpoint])
}
