generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ww_user {
  id                Int             @id @default(autoincrement())
  wakawars_username String          @unique
  api_key           String          @default("")
  wakatime_timezone String?
  password_hash     String?
  stats_visibility  ww_stats_visibility @default(everyone)
  is_competing      Boolean         @default(true)
  coin_balance      Int             @default(0)
  equipped_skin_id  String?
  equipped_skin     ww_skin_catalog? @relation("equipped_skin", fields: [equipped_skin_id], references: [id], onDelete: SetNull)
  friendships       ww_friendship[] @relation("user_friendships")
  friend_of         ww_friendship[] @relation("friend_friendships")
  groups_owned      ww_group[]      @relation("group_owner")
  group_memberships ww_group_member[] @relation("group_member")
  sessions          ww_session[]
  daily_stats       ww_daily_stat[]
  weekly_stats      ww_weekly_stat[]
  owned_skins       ww_user_skin[]
  coin_ledger       ww_coin_ledger[]
  daily_reward_settlements ww_daily_reward_settlement[]
  achievements      ww_user_achievement[]
  provider_logs     ww_provider_log[]
  created_at        DateTime        @default(now())
  updated_at        DateTime        @updatedAt
}

enum ww_stats_visibility {
  everyone
  friends
  no_one
}

model ww_group {
  id         Int               @id @default(autoincrement())
  owner_id   Int
  name       String
  owner      ww_user           @relation("group_owner", fields: [owner_id], references: [id], onDelete: Cascade)
  members    ww_group_member[]
  created_at DateTime          @default(now())
  updated_at DateTime          @updatedAt

  @@unique([owner_id, name])
  @@index([owner_id])
}

model ww_group_member {
  id         Int      @id @default(autoincrement())
  group_id   Int
  user_id    Int
  group      ww_group @relation(fields: [group_id], references: [id], onDelete: Cascade)
  user       ww_user  @relation("group_member", fields: [user_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([group_id, user_id])
  @@index([user_id])
}

model ww_friendship {
  id         Int      @id @default(autoincrement())
  user_id    Int
  friend_id  Int
  user       ww_user  @relation("user_friendships", fields: [user_id], references: [id], onDelete: Cascade)
  friend     ww_user  @relation("friend_friendships", fields: [friend_id], references: [id], onDelete: Cascade)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@unique([user_id, friend_id])
  @@index([friend_id])
}

model ww_session {
  id           Int      @id @default(autoincrement())
  token        String   @unique
  user_id      Int
  user         ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  created_at   DateTime @default(now())
  last_used_at DateTime @default(now())
}

model ww_daily_stat {
  id            Int      @id @default(autoincrement())
  user_id       Int
  user          ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  date_key      String
  total_seconds Int      @default(0)
  status        String
  error         String?
  fetched_at    DateTime @default(now())
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  @@unique([user_id, date_key])
  @@index([date_key])
}

model ww_weekly_stat {
  id                    Int      @id @default(autoincrement())
  user_id               Int
  user                  ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  range_key             String
  total_seconds         Int      @default(0)
  daily_average_seconds Int      @default(0)
  status                String
  error                 String?
  fetched_at            DateTime @default(now())
  created_at            DateTime @default(now())
  updated_at            DateTime @updatedAt

  @@unique([user_id, range_key])
  @@index([range_key])
}

enum ww_coin_transaction_reason {
  daily_rank_reward
  skin_purchase
}

model ww_skin_catalog {
  id          String        @id
  name        String
  description String
  price_coins Int
  is_active   Boolean       @default(true)
  sort_order  Int           @default(0)
  users_equipped ww_user[]  @relation("equipped_skin")
  owned_by    ww_user_skin[]
  created_at  DateTime      @default(now())
  updated_at  DateTime      @updatedAt

  @@index([is_active, sort_order])
}

model ww_user_skin {
  id           Int      @id @default(autoincrement())
  user_id      Int
  user         ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  skin_id      String
  skin         ww_skin_catalog @relation(fields: [skin_id], references: [id], onDelete: Restrict)
  purchased_at DateTime @default(now())
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([user_id, skin_id])
  @@index([skin_id])
}

model ww_coin_ledger {
  id         Int                        @id @default(autoincrement())
  user_id    Int
  user       ww_user                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  amount     Int
  reason     ww_coin_transaction_reason
  metadata   Json?
  created_at DateTime                   @default(now())
  updated_at DateTime                   @updatedAt

  @@index([user_id, created_at])
}

model ww_daily_reward_settlement {
  id           Int      @id @default(autoincrement())
  user_id      Int
  user         ww_user  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  date_key     String
  rank         Int?
  coins_awarded Int     @default(0)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@unique([user_id, date_key])
  @@index([date_key])
}

enum ww_achievement_context_kind {
  daily
  weekly
}

model ww_user_achievement {
  id              Int                         @id @default(autoincrement())
  user_id         Int
  user            ww_user                     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  achievement_key String
  context_kind    ww_achievement_context_kind
  context_key     String
  metadata        Json?
  awarded_at      DateTime
  created_at      DateTime                    @default(now())
  updated_at      DateTime                    @updatedAt

  @@unique([user_id, achievement_key, context_kind, context_key])
  @@index([user_id, awarded_at])
  @@index([achievement_key])
}

model ww_provider_log {
  id          Int      @id @default(autoincrement())
  provider    String
  user_id     Int?
  user        ww_user? @relation(fields: [user_id], references: [id], onDelete: SetNull)
  endpoint    String
  range_key   String?
  status_code Int?
  ok          Boolean  @default(false)
  payload     Json?
  error       String?
  fetched_at  DateTime @default(now())
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  @@index([provider])
  @@index([user_id])
  @@index([endpoint])
}
